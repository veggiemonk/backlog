---
id: "18.03"
title: Implement file-based locking for ID generation
status: done
assignee: '@me'
labels:
    - implementation
    - core
    - store
dependencies: T18.02
parent: "18"
priority: high
created_at: 2025-09-21T21:59:11.609887Z
updated_at: 2025-09-21T22:24:12.045795Z
history:
    - timestamp: 2025-09-21T21:59:14.333501Z
      change: Description changed
    - timestamp: 2025-09-21T21:59:17.050375Z
      change: 'Added acceptance criterion #1: "A lock file (e.g."'
    - timestamp: 2025-09-21T21:59:17.050375Z
      change: 'Added acceptance criterion #2: " .backlog/store.lock) is created and acquired before ID generation."'
    - timestamp: 2025-09-21T21:59:19.566854Z
      change: 'Added acceptance criterion #3: "The lock is released after the new task file is successfully written."'
    - timestamp: 2025-09-21T21:59:22.671783Z
      change: 'Added acceptance criterion #4: "The implementation includes proper error handling for lock acquisition failures (e.g."'
    - timestamp: 2025-09-21T21:59:22.671784Z
      change: 'Added acceptance criterion #5: " timeouts)."'
    - timestamp: 2025-09-21T21:59:25.183238Z
      change: 'Added acceptance criterion #6: "Unit tests are added to verify the locking behavior."'
    - timestamp: 2025-09-21T22:21:54.343608Z
      change: Status changed from "todo" to "in-progress"
      type: field_update
    - timestamp: 2025-09-21T22:21:56.727174Z
      change: Implementation plan changed
      type: field_update
    - timestamp: 2025-09-21T22:22:24.53159Z
      change: Status changed from "in-progress" to "done"
      type: field_update
    - timestamp: 2025-09-21T22:22:24.531591Z
      change: Implementation notes changed
      type: field_update
    - timestamp: 2025-09-21T22:22:24.531592Z
      change: 'Checked acceptance criterion #1: "A lock file (e.g."'
      type: field_update
    - timestamp: 2025-09-21T22:22:24.531593Z
      change: 'Checked acceptance criterion #2: " .backlog/store.lock) is created and acquired before ID generation."'
      type: field_update
    - timestamp: 2025-09-21T22:22:24.531593Z
      change: 'Checked acceptance criterion #3: "The lock is released after the new task file is successfully written."'
      type: field_update
    - timestamp: 2025-09-21T22:22:24.531594Z
      change: 'Checked acceptance criterion #4: "The implementation includes proper error handling for lock acquisition failures (e.g."'
      type: field_update
    - timestamp: 2025-09-21T22:24:04.600432Z
      change: Implementation notes changed
      type: field_update
    - timestamp: 2025-09-21T22:24:12.045794Z
      change: Implementation notes changed
      type: field_update
---
## Description

Implement a file-based locking mechanism within the FileTaskStore to ensure that ID generation and file creation are atomic operations. This will prevent race conditions when multiple processes try to create tasks simultaneously.

## Acceptance Criteria
<!-- AC:BEGIN -->

- [x] #1 A lock file (e.g.
- [x] #2  .backlog/store.lock) is created and acquired before ID generation.
- [x] #3 The lock is released after the new task file is successfully written.
- [x] #4 The implementation includes proper error handling for lock acquisition failures (e.g.
- [ ] #5  timeouts).
- [ ] #6 Unit tests are added to verify the locking behavior.

<!-- AC:END -->

## Implementation Plan

1. Add go-filemutex dependency. 2. Modify FileTaskStore with FileMutex field. 3. Initialize FileMutex in NewFileTaskStore. 4. Implement Lock() and Unlock() methods in FileTaskStore. 5. Ensure error handling and defer Unlock().

## Implementation Notes

Attempted file-based locking with go-filemutex, but it is incompatible with afero.Fs in-memory filesystem used for testing. Reverted all changes.
